## Wireguard Control — Web-интерфейс для wireguard
Простой web-интерфейс для VPN-wireguard с возможностью как использовать уже созданные конфиги, так и настраивать свои.

### Возможности
 - Добавление и удаление клиентов через web-интерфейс, сразу с предпросмотром QR-кода
 - Отслеживание статуса в интерфейсе
 - Перезагрузка Wireguard через web-интерфейс
 - Работа с несколькими `.conf`-файлами (интерфейсами)
 - Максимально простой веб-интерфейс, написан на чистом JS без фреймворков, можно править всё что необходимо прямо на месте
 - Ротация проверочного кода на фронте (в репозитории больше нет захардкоженных секретов)
 - Секреты клиентов (приватные ключи и PSK) шифруются перед сохранением в `.data/peers.json`
 - Не использует никакие базы данных (данные хранятся в JSON)

### Особенности
 - Для применения конфига (*например после добавления клиента*) требуется перезагрузка Wireguard
 - Требует установленной NodeJS, а также, желательно PM2, чтобы поддерживать автоматический перезапуск

### Подготовка
Для работы нужен сам Wireguard и NodeJS. Гайд ниже для Ubuntu.
```bash
sudo apt install wireguard
```
Самый простой способ установить NodeJS нужной версии это [NVM](https://github.com/nvm-sh/nvm). Данный проект тестировался на NodeJS v.20.10, но вероятно будет работать и на более старых версиях (вероятно на 12-й работать должен), поэтому можете попробовать просто поставить NodeJS через `apt`. Далее пример команд для установки NVM:
```bash
wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash

source ~/.bashrc
```
Проверить, что `nvm` установлен можно командой `nvm -v`. После этого ставим рекомендуемую версию ноды:
```bash
nvm install 20.10.0
```

### Установка из исходников
Клонирем репозиторий в удобную вам папку (здесь для примера это `/var/wg-control`):
```bash
git clone https://github.com/Psychosynthesis/WireguardControl.git /var/wg-control
```

Переходим в созданную папку и устанавливаем зависимости:
```bash
cd /var/wg-control
npm i
npm run build
```

### Запуск
Переходим в ранее созданную папку и запускаем сервер:
```bash
cd /var/wg-control

npm run start
```
Не забудьте указать свои настройки в файле `config.example.json` (при первом запуске он будет переименован в `config.json`). Вам следует указать ваш дефольный WG-интерфейс и добавить IP вашего сервера (в сети VPN) в `allowedOrigins`. Также убедитесь, что `webServerPort`, используемый этим сервером по умолчанию (`8877`), открыт в брандмауэре (если у вас включена блокировка портов).

**ОБЯЗАТЕЛЬНО ИЗМЕНИТЕ ВСЕ КЛЮЧИ ПО УМОЛЧАНИЮ!**

Вы можете сгенерировать себе случайный ключ прямо в bash, например следующими способами:
```bash
# C помощью openssl:
openssl rand -base64 16
# C использованием /dev/urandom и base64:
head -c 16 /dev/urandom | base64
```
Либо выполните в консоли разработчика в браузере, открыв веб-интерфейс Wireguard Control:
```javascript
// Библиотека forge используется в public\index.html для шифрования
forge.util.encode64(forge.random.getBytes(16));
```

Далее следует добавить скрипт сервера в автозагрузку. Есть несколько способов сделать это, но самый удобный и простой это воспользоваться инструментом `pm2`, он, помимо прочего, позволяет распараллеливать нагрузку, а также следить за потреблением памяти.

```bash
npm install pm2 -g
cd /var/wg-control && pm2 start demon.json --watch --ignore-watch="node_modules"
pm2 startup
pm2 save
```
Теперь для мониторинга состояния сервера достаточно запустить `pm2 monit`.

### Конфигурация

Файл `config.json` (создаётся из `config.example.json` при первом запуске) содержит следующие поля:

| Ключ | Описание |
| --- | --- |
| `defaultInterface` | Имя интерфейса (без `.conf`), который выбирается по умолчанию |
| `frontServerPort` | Порт, на котором слушает Express-сервер |
| `allowedOrigins` | Список разрешённых origin для CORS |
| `frontendPasskey` | Ключ, которым шифруются ответы API (нужно вводить на фронте) |
| `dns` | Массив DNS-серверов, которые попадут в сгенерированные конфиги клиентов |
| `clientEncryptionPass` | Пароль для AES-шифрования приватных ключей в `.data/peers.json` |
| `runtimeRotationMinutes` | Интервал ротации проверочного скрипта `public/assets/runtime.js` |

### CLI / установка из npm

Теперь проект можно ставить и обновлять через npm. После установки глобально доступны простые команды:

```bash
npm install -g @gratio/wg      # после установки глобально доступна команда `wg-control`
wg-control init-config         # создаёт config.json из примера, если его ещё нет
wg-control serve               # запускает сервер (то же самое что npm run start)

# Без глобальной установки:
npx @gratio/wg init-config
npx @gratio/wg serve
```

Команды выполняются в текущей директории — запускайте их из папки с вашим `config.json` и `.data`, чтобы сервер сразу подцепил нужные данные. Для обновления используйте `npm update -g @gratio/wg`.

### Дополнительная информация

Дополнительные данные о клиентах хранятся в `.data/peers.json`. В JSON помимо имени и IP теперь есть зашифрованные поля `secretKey` и `presharedKey`. Расшифровать их можно только зная `clientEncryptionPass` из `config.json`. При загрузке `Wireguard-Control` ищет все доступные конфиги в `/etc/wireguard`, парсит и держит их в памяти, поэтому для чтения статуса не требуется постоянно обращаться к файлам.

### Дополнительно

[Пример конфигурации Wireguard для корпоративной сети](./sample.conf.md)
