import u from"@gratio/crypt";import{readJSON as g,saveJSON as d}from"boma";import{CONFIG_PATH as c}from"../utils/constants.js";import{initRuntimeGuard as p}from"../core/runtimeGuard.js";import{getActiveInterfaceses as l,getCurrentEndpoint as y,getDefaultInterface as m,getFrontendConfig as i,getIfaceParams as I,getInterfacePeersIPs as P,getFirstAvailableIP as C,loadServerConfig as F,parseInterfaceConfig as S}from"../utils/index.js";const j=u.serverCrypt.encryptMsg,O=async(a,r,n)=>{const e=a.query.iface;try{const t=await S(e);t.interface["External IP"]=y();const{frontendPasskey:o}=i(),s=j({message:t,pass:o});r.status(200).json({success:!0,data:s})}catch(t){console.error("getConfig service error: ",t),r.status(520).json({success:!1,errors:"Can`t get Wireguard config"}),n(t)}},b=async(a,r,n)=>{try{const e=l(),t=m(),o=e.map(s=>({checked:s===t,value:s}));r.status(200).json({success:!0,data:o})}catch(e){console.error("getInterfaces service error: ",e),r.status(520).json({success:!1,errors:"Can`t get Wireguard Interfaces"}),n(e)}},A=async(a,r,n)=>{const e=a.query.iface;try{const t=I(e);if(!t.success||!t.data){r.status(422).json(t);return}const o=P(e),{cidr:s}=t.data;r.status(200).json({success:!0,data:C(o,s)})}catch(t){console.error("getFirstFreeIP service error: ",t),r.status(520).json({success:!1,errors:"Can`t get new free IP"}),n(t)}},J=async(a,r,n)=>{const{dns:e,frontendPasskey:t,runtimeRotationMinutes:o}=a.body;try{const s=g({filePath:c,parseJSON:!0,createIfNotFound:{}});Array.isArray(e)?s.dns=e.filter(Boolean):typeof e=="string"&&(s.dns=e.split(",").map(f=>f.trim()).filter(Boolean)),t&&typeof t=="string"&&t.trim()&&(s.frontendPasskey=t.trim()),typeof o=="number"&&o>0&&(s.runtimeRotationMinutes=o),d({filePath:c,objToSave:JSON.parse(JSON.stringify(s)),format:!0,logSaving:!1}),await F(),p(s.runtimeRotationMinutes??5),r.status(200).json({success:!0})}catch(s){console.error("updateFrontendSettings error: ",s),r.status(520).json({success:!1,errors:"Can`t update frontend settings"}),n(s)}},R=async(a,r,n)=>{try{const{dns:e,runtimeRotationMinutes:t}=i();r.status(200).json({success:!0,data:{dns:e,runtimeRotationMinutes:t}})}catch(e){console.error("getFrontendSettings error: ",e),r.status(520).json({success:!1,errors:"Can`t load frontend settings"}),n(e)}};export{A as getFirstFreeIP,R as getFrontendSettings,O as getInterfaceConfig,b as getInterfaces,J as updateFrontendSettings};
