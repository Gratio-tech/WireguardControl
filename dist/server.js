import i from"cors";import l from"cookie-parser";import d from"express";import{inspect as f}from"node:util";import{initRuntimeGuard as p}from"./core/runtimeGuard.js";import{setSecurityHeaders as g,verifyClient as a}from"./middlewares/index.js";import{loadServerConfig as w,getFrontendConfig as h}from"./utils/index.js";import v from"./routes/config.router.js";import R from"./routes/wireguard.router.js";import y from"./routes/frontend.router.js";await w();const{frontServerPort:n,allowedOrigins:o,runtimeRotationMinutes:S}=h();p(S??5);const C=(e,P,t,m)=>{if(t.headersSent)return m(e);const s=e?.status||500,c=e instanceof Error?e.message:"Unknown error";console.error("Unhandled error:",f(e,{depth:null,colors:!0})),t.status(s).json({success:!1,message:s===500?"Internal server error. Please contact support.":c,errorId:Date.now()})},r=d();r.disable("x-powered-by");r.use(l());r.use(g);r.use("/",y);const u={origin:o&&o.length?o:void 0,credentials:!0};r.use("/api/config",i(u),a,v);r.use("/api/wireguard",i(u),a,R);r.use(C);r.listen(n,()=>{console.log(`Wireguard-control ready on http://localhost:${n}`)});
